version: "3.9"

services:
  # Redis is REQUIRED for LiveKit SIP service (and for livekit-server <-> SIP coordination).
  # CRITICAL: host networking avoids Docker iptables/NAT explosion, even with port ranges.
  redis:
    image: redis:7-alpine
    container_name: livekit-redis
    restart: unless-stopped
    network_mode: host
    command:
      # Bind only to localhost (host network exposes ports directly)
      - redis-server
      - --bind
      - 127.0.0.1
      - --protected-mode
      - "yes"
      - --appendonly
      - "yes"
    volumes:
      - livekit-redis-data:/data

  livekit-server:
    image: livekit/livekit-server:latest
    container_name: livekit-server
    restart: unless-stopped
    network_mode: host
    # Ensure livekit-server loads our config (including Redis, required for SIP APIs)
    command: ["--config", "/etc/livekit.yaml"]
    # CRITICAL: Using host networking to avoid Docker iptables/NAT explosion
    # With host networking, ports are opened directly on the host - no Docker NAT rules
    # Make sure to open these ports in EC2 Security Group / firewall:
    # - 7880/tcp (HTTP/WebSocket)
    # - 7881/tcp (HTTPS/WSS)
    # - 50000-60000/udp (RTC UDP ports)
    # - 5060/udp (SIP UDP)
    # - 5061/tcp (SIP TLS)
    volumes:
      - ./livekit-config.yaml:/etc/livekit.yaml:ro
      - livekit-data:/var/lib/livekit
    env_file:
      - .env.livekit
    environment:
      # CRITICAL: LiveKit requires format "key: secret" with space after colon.
      # NOTE: This value must be a single string; use mapping style to avoid YAML parsing issues.
      LIVEKIT_KEYS: "${LIVEKIT_API_KEY}: ${LIVEKIT_API_SECRET}"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7880/"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - redis

  coturn:
    image: coturn/coturn:latest
    container_name: livekit-coturn
    restart: unless-stopped
    network_mode: host
    # CRITICAL: Using host networking to avoid Docker iptables/NAT explosion
    # With host networking, ports are opened directly on the host - no Docker NAT rules
    # Make sure to open these ports in EC2 Security Group / firewall:
    # - 3478/udp (STUN)
    # - 3478/tcp (STUN)
    # - 49152-65535/udp (TURN relay ports)
    volumes:
      - ./coturn-config.conf:/etc/coturn/turnserver.conf:ro
    command: ["-c", "/etc/coturn/turnserver.conf"]

  # LiveKit SIP Service (required for Telnyx SIP trunk calls to show up as participants)
  # Docs: https://github.com/livekit/sip
  livekit-sip:
    image: livekit/sip:latest
    container_name: livekit-sip
    restart: unless-stopped
    network_mode: host
    env_file:
      - .env.livekit
    environment:
      # Using SIP_CONFIG_BODY is the simplest self-contained setup (no extra file mount needed).
      # IMPORTANT: rtp_port range should be kept small unless you truly need high concurrency.
      SIP_CONFIG_BODY: |
        log_level: info
        api_key: "${LIVEKIT_API_KEY}"
        api_secret: "${LIVEKIT_API_SECRET}"
        ws_url: "ws://localhost:7880"
        redis:
          address: "localhost:6379"
        sip_port: 5060
        rtp_port: 10000-10100
        use_external_ip: true
    depends_on:
      - redis
      - livekit-server

volumes:
  livekit-data:
  livekit-redis-data:

